{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Novo Aluno{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card-form">
            <div class="form-header">
                <h2>游녻 Cadastrar Novo Aluno</h2>
                <p>Registro administrativo (Secretaria)</p>
            </div>

            
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <h5 class="text-primary mb-3"><i class="bi bi-key"></i> Acesso</h5>
                {{ user_form|crispy }}
                
                <hr class="my-4">
                
                <h5 class="text-primary mb-3"><i class="bi bi-person-vcard"></i> Dados Pessoais</h5>
                {{ aluno_form|crispy }}
                <div class="text-center mb-4 p-3 border rounded bg-light">
                <h5>游닞 Tirar Foto na Hora (Webcam)</h5>
                
                <div id="camera_container" style="display: none; margin-bottom: 10px;">
                    <video id="video" width="320" height="240" autoplay style="border-radius: 10px; border: 3px solid #ccc;"></video>
                    <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
                </div>

                <div>
                    <button type="button" id="btn-start" class="btn btn-info btn-sm text-white">
                        <i class="bi bi-camera-video"></i> Ligar C칙mera
                    </button>
                    
                    <button type="button" id="btn-capture" class="btn btn-warning btn-sm text-dark" style="display: none;">
                        <i class="bi bi-camera"></i> Capturar Foto
                    </button>
                </div>
                
                <div id="preview_container" style="display: none; margin-top: 10px;">
                    <p class="small text-success fw-bold">Foto capturada com sucesso!</p>
                    <img id="photo_preview" src="" style="width: 150px; border-radius: 10px; border: 2px solid #27ae60;">
                </div>
            </div>
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn-submit">Confirmar Cadastro</button>
                    <a href="{% url 'listar_alunos' %}" class="btn btn-link text-muted text-decoration-none text-center">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Pegamos os elementos da tela
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const btnStart = document.getElementById('btn-start');
    const btnCapture = document.getElementById('btn-capture');
    const cameraContainer = document.getElementById('camera_container');
    const previewContainer = document.getElementById('preview_container');
    const photoPreview = document.getElementById('photo_preview');
    
    // O campo de arquivo do Django sempre tem o ID 'id_foto'
    const inputFoto = document.getElementById('id_foto');

    // 1. Ligar a C칙mera
    btnStart.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
            cameraContainer.style.display = 'block';
            btnStart.style.display = 'none';
            btnCapture.style.display = 'inline-block';
            previewContainer.style.display = 'none';
        } catch (err) {
            alert("N칚o foi poss칤vel acessar a c칙mera. Verifique as permiss칫es do navegador.");
            console.error("Erro na c칙mera:", err);
        }
    });

    // 2. Tirar a Foto
    btnCapture.addEventListener('click', () => {
        // Desenha o v칤deo no canvas (congelar a imagem)
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, 320, 240);
        
        // Converte para arquivo
        canvas.toBlob((blob) => {
            // Cria um arquivo de imagem na mem칩ria
            const file = new File([blob], "webcam_foto.jpg", { type: "image/jpeg" });
            
            // --- A M츼GICA: Coloca esse arquivo dentro do input do Django ---
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            inputFoto.files = dataTransfer.files;
            
            // Mostra o preview visual para o usu치rio saber que funcionou
            photoPreview.src = URL.createObjectURL(file);
            previewContainer.style.display = 'block';
            
            // Desliga a c칙mera para economizar bateria
            const stream = video.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
            video.srcObject = null;
            
            cameraContainer.style.display = 'none';
            btnCapture.style.display = 'none';
            btnStart.style.display = 'inline-block';
            btnStart.textContent = "Tirar Outra Foto";
            btnStart.className = "btn btn-secondary btn-sm";

        }, 'image/jpeg');
    });
</script>

<script>
    document.getElementById("id_username").addEventListener("blur", function() {
        var username = this.value;
        var inputField = this;
        var feedbackDiv = document.getElementById("username-feedback");

        // Se n칚o existir a div de feedback, cria ela
        if (!feedbackDiv) {
            feedbackDiv = document.createElement("div");
            feedbackDiv.id = "username-feedback";
            feedbackDiv.className = "invalid-feedback fw-bold"; // Classe do Bootstrap
            inputField.parentNode.appendChild(feedbackDiv);
        }

        if (username) {
            // Faz a chamada para a nossa view criada no Passo 2
            fetch(`/ajax/verificar-usuario/?username=${username}`)
                .then(response => response.json())
                .then(data => {
                    if (data.existe) {
                        // Se existe: Borda vermelha e mensagem de erro
                        inputField.classList.add("is-invalid");
                        inputField.classList.remove("is-valid");
                        feedbackDiv.textContent = "丘멆잺 Este usu치rio j치 existe! Escolha outro.";
                    } else {
                        // Se est치 livre: Borda verde
                        inputField.classList.remove("is-invalid");
                        inputField.classList.add("is-valid");
                        feedbackDiv.textContent = "";
                    }
                });
        }
    });
</script>
{% endblock %}