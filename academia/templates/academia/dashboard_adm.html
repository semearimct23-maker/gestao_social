{% extends 'base.html' %}

{% block title %}Dashboard Administrativo{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .card-widget {
        border: none;
        border-radius: 15px;
        background: white;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        height: 100%; /* Garante altura igual */
    }
    .card-widget:hover { transform: translateY(-5px); }
    
    .icon-box {
        width: 50px; height: 50px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; margin-bottom: 10px;
    }
    
    .bg-purple { background-color: #e0e7ff; color: #4f46e5; }
    .bg-green { background-color: #dcfce7; color: #16a34a; }
    .bg-yellow { background-color: #fef9c3; color: #ca8a04; }
    .bg-red { background-color: #fee2e2; color: #dc2626; }
    
    .widget-title { color: #64748b; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;}
    .widget-value { font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-bottom: 0; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="fw-bold text-dark mb-0">Visão Geral</h3>
        <p class="text-muted small">Indicadores de {{ mes_atual }}/{{ ano_atual }}</p>
    </div>
    
    <form method="GET" class="d-flex align-items-center gap-2 bg-white p-2 rounded shadow-sm">
    
    <select name="mes" class="form-select border-0 bg-light fw-bold text-secondary" style="width: 130px;">
        <option value="1" {% if mes_atual == 1 %}selected{% endif %}>Janeiro</option>
        <option value="2" {% if mes_atual == 2 %}selected{% endif %}>Fevereiro</option>
        <option value="3" {% if mes_atual == 3 %}selected{% endif %}>Março</option>
        <option value="4" {% if mes_atual == 4 %}selected{% endif %}>Abril</option>
        <option value="5" {% if mes_atual == 5 %}selected{% endif %}>Maio</option>
        <option value="6" {% if mes_atual == 6 %}selected{% endif %}>Junho</option>
        <option value="7" {% if mes_atual == 7 %}selected{% endif %}>Julho</option>
        <option value="8" {% if mes_atual == 8 %}selected{% endif %}>Agosto</option>
        <option value="9" {% if mes_atual == 9 %}selected{% endif %}>Setembro</option>
        <option value="10" {% if mes_atual == 10 %}selected{% endif %}>Outubro</option>
        <option value="11" {% if mes_atual == 11 %}selected{% endif %}>Novembro</option>
        <option value="12" {% if mes_atual == 12 %}selected{% endif %}>Dezembro</option>
    </select>
    
    <select name="ano" class="form-select border-0 bg-light fw-bold text-secondary" style="width: 90px;">
        <option value="2025" {% if ano_atual == 2025 %}selected{% endif %}>2025</option>
        <option value="2026" {% if ano_atual == 2026 %}selected{% endif %}>2026</option>
    </select>
    
    <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center p-0" style="width: 38px; height: 38px;">
        <i class="bi bi-search"></i>
    </button>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card-widget">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="widget-title">Alunos Ativos</div>
                    <h2 class="widget-value">{{ total_ativos }}</h2>
                </div>
                <div class="icon-box bg-purple"><i class="bi bi-people-fill"></i></div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card-widget">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="widget-title">Receita (Mês)</div>
                    <h2 class="widget-value text-success">R$ {{ receita_mes }}</h2>
                </div>
                <div class="icon-box bg-green"><i class="bi bi-currency-dollar"></i></div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <a href="{% url 'area_cobranca' %}?mes={{ mes_atual }}&ano={{ ano_atual }}" style="text-decoration: none;">
            <div class="card-widget">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="widget-title text-danger">Pendentes</div>
                        <h2 class="widget-value text-danger">{{ total_inadimplentes }}</h2>
                    </div>
                    <div class="icon-box bg-red"><i class="bi bi-exclamation-triangle"></i></div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-6 col-md-3">
        <div class="card-widget" {% if total_risco > 0 %}style="border: 2px solid #dc3545;"{% endif %}>
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="widget-title text-dark">Risco de Evasão</div>
                    <h2 class="widget-value {% if total_risco > 0 %}text-danger{% else %}text-muted{% endif %}">{{ total_risco }}</h2>
                    <small class="text-muted" style="font-size: 0.65rem;">Alunos com +2 faltas</small>
                </div>
                <div class="icon-box {% if total_risco > 0 %}bg-red text-danger{% else %}bg-light text-muted{% endif %}">
                    <i class="bi bi-person-x-fill"></i>
                </div>
            </div>
        </div>
    </div>
</div> 

<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4 d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3 text-primary">
                        <i class="bi bi-calendar-check-fill fs-3"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-1 text-dark">Gestão de Chamadas e Frequência</h5>
                        <p class="text-muted mb-0 small">Acesse os diários de classe, consulte presenças e justifique faltas manualmente.</p>
                    </div>
                </div>
                <a href="{% url 'gerenciar_chamada_adm' %}" class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm text-nowrap">
                    <i class="bi bi-arrow-right-circle me-2"></i> Acessar Diários
                </a>
            </div>
        </div>
    </div>
</div>
{% if total_risco > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm bg-danger text-white">
            <div class="card-header bg-danger border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold"><i class="bi bi-megaphone-fill"></i> Atenção Necessária: Alunos Faltosos</h6>
            </div>
            <div class="card-body bg-white p-0 rounded-bottom">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Aluno</th>
                                <th>Curso</th>
                                <th class="text-center">Faltas</th>
                                <th>Responsável</th>
                                <th class="text-end pe-4">Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in lista_risco %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.nome_aluno }}</td>
                                <td>{{ item.nome_curso }}</td>
                                <td class="text-center"><span class="badge bg-danger rounded-pill">{{ item.qtd_faltas }}</span></td>
                                <td class="small">{{ item.nome_responsavel|default:"-" }}</td>
                                <td class="text-end pe-4">
                                    {% if item.link_zap %}
                                    <a href="https://wa.me/{{ item.link_zap }}?text=Olá, notamos sua ausência em {{ item.nome_curso }}." target="_blank" class="btn btn-sm btn-outline-success rounded-pill">
                                        <i class="bi bi-whatsapp"></i> Falar
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white py-3 border-0">
                <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-bar-chart-fill text-primary"></i> Arrecadação Anual ({{ ano_atual }})</h6>
            </div>
            <div class="card-body">
                <canvas id="receitaChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white py-3 border-0">
                <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-person-plus-fill text-success"></i> Novas Matrículas</h6>
            </div>
            <div class="card-body">
                <canvas id="alunosChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold"><i class="bi bi-calendar-check text-primary"></i> Aulas de Hoje</h6>
                <span class="badge bg-light text-dark border">{% now "D, d/m" %}</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0 small">
                    <thead class="bg-light">
                        <tr><th class="ps-3">Curso</th><th class="text-center">Horário</th><th class="text-end pe-3">Qtd</th></tr>
                    </thead>
                    <tbody>
                        {% for item in lista_cursos_hoje %}
                        <tr onclick="window.location.href='{% url 'agenda_geral' %}?data={% now 'Y-m-d' %}'" style="cursor:pointer;">
                            <td class="ps-3 fw-bold">{{ item.nome }}</td>
                            <td class="text-center text-muted">{{ item.inicio }} - {{ item.fim }}</td>
                            <td class="text-end pe-3"><span class="badge bg-secondary">{{ item.total_alunos }}</span></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center py-3 text-muted">Sem aulas hoje.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-wallet2 text-success"></i> Pagamento Docente</h6>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0 small">
                    <thead class="bg-light"><tr><th class="ps-3">Prof.</th><th class="text-end pe-3">Valor</th></tr></thead>
                    <tbody>
                        {% for pg in lista_pagamento_prof %}
                        <tr>
                            <td class="ps-3">{{ pg.nome }}</td>
                            <td class="text-end pe-3 fw-bold text-success">R$ {{ pg.valor }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white border-0 text-center">
                <a href="{% url 'financeiro_professores' %}" class="btn btn-sm btn-outline-success w-100">Gerenciar</a>
            </div>
        </div>
    </div>
</div>

<script>
    const ctxReceita = document.getElementById('receitaChart').getContext('2d');
    const ctxAlunos = document.getElementById('alunosChart').getContext('2d');

    // Dados vindos do Django (backend)
    const dadosReceita = {{ grafico_receita|safe }};
    const dadosAlunos = {{ grafico_novos_alunos|safe }};
    const labelsMeses = {{ meses_label|safe }};

    // 1. Gráfico de Receita (Barra)
    new Chart(ctxReceita, {
        type: 'bar',
        data: {
            labels: labelsMeses,
            datasets: [{
                label: 'Arrecadação (R$)',
                data: dadosReceita,
                backgroundColor: 'rgba(79, 70, 229, 0.7)', // Roxo
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // 2. Gráfico de Novos Alunos (Linha)
    new Chart(ctxAlunos, {
        type: 'line',
        data: {
            labels: labelsMeses,
            datasets: [{
                label: 'Novos Alunos',
                data: dadosAlunos,
                borderColor: '#16a34a', // Verde
                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
        }
    });
</script>

{% endblock %}