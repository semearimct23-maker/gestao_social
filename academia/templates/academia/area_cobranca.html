{% extends 'base.html' %}

{% block title %}Central de Cobran√ßa{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-danger"><i class="bi bi-megaphone"></i> Central de Cobran√ßa</h2>
        <p class="text-muted">Gerencie os alunos pendentes do m√™s {{ mes_atual }}/{{ ano_atual }}.</p>
    </div>
    
    <form method="GET" class="d-flex gap-2 bg-white p-2 rounded shadow-sm">
        <select name="mes" class="form-select border-0 bg-light" style="min-width: 140px;">
            <option value="1" {% if mes_atual == 1 %}selected{% endif %}>Janeiro</option>
            <option value="1" {% if mes_atual == 2 %}selected{% endif %}>Fevereiro</option>
            <option value="1" {% if mes_atual == 3 %}selected{% endif %}>Mar√ßo</option>
            <option value="1" {% if mes_atual == 4 %}selected{% endif %}>Abril</option>
            <option value="1" {% if mes_atual == 5 %}selected{% endif %}>Maio</option>
            <option value="1" {% if mes_atual == 6 %}selected{% endif %}>Junho</option>
            <option value="1" {% if mes_atual == 7 %}selected{% endif %}>Julho</option>
            <option value="1" {% if mes_atual == 8 %}selected{% endif %}>Agosto</option>
            <option value="1" {% if mes_atual == 9 %}selected{% endif %}>Setembro</option>
            <option value="1" {% if mes_atual == 10 %}selected{% endif %}>Outubro</option>
            <option value="11" {% if mes_atual == 11 %}selected{% endif %}>Novembro</option>
            <option value="12" {% if mes_atual == 12 %}selected{% endif %}>Dezembro</option>
        </select>
        <select name="ano" class="form-select border-0 bg-light" style="min-width: 85px;">
            <option value="2025" {% if ano_atual == 2025 %}selected{% endif %}>2025</option>
            <option value="2026" {% if ano_atual == 2026 %}selected{% endif %}>2026</option>
        </select>
        <button type="submit" class="btn btn-primary rounded-circle"><i class="bi bi-search"></i></button>
    </form>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
       <div class="card border-0 shadow-sm bg-light-purple">
            <div class="card-body d-flex align-items-center gap-3">
                <i class="bi bi-whatsapp fs-2 text-success"></i>
                <div class="flex-grow-1">
                    <label class="fw-bold text-primary mb-1">Escolha a Mensagem de Cobran√ßa:</label>
                    <div class="d-flex gap-2">
                        <select id="selectMensagem" class="form-select" onchange="atualizarLinks()">
                            <option value="Ol√°, tudo bem? N√£o identificamos seu pagamento.">-- Padr√£o (Simples) --</option>
                            {% for msg in mensagens %}
                                <option value="{{ msg.texto }}">{{ msg.titulo }}</option>
                            {% endfor %}
                        </select>
                        
                        <a href="{% url 'gerenciar_mensagens' %}" class="btn btn-light border" title="Criar novas mensagens">
                            <i class="bi bi-gear-fill text-secondary"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Aluno</th>
                    <th>Pend√™ncias ({{ mes_atual }}/{{ ano_atual }})</th> 
                    <th>Contato</th>
                    <th class="text-end pe-4">A√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                {% for devedor in lista_inadimplentes %}
                <tr>
                    <td class="ps-4">
                        <a href="{% url 'relatorio_financeiro_aluno' devedor.id %}" class="fw-bold text-dark text-decoration-none">
                            {{ devedor.nome }}
                        </a>
                        <div class="small text-muted">
                            <i class="bi bi-person-fill"></i> Resp: {{ devedor.nome_tratamento }} | 
                            <i class="bi bi-book"></i> {{ devedor.nome_cursos }}
                        </div>
                    </td>
                    
                    <td><span class="badge bg-danger">Pendente</span></td>

                    <td>{{ devedor.telefone }}</td>
                    <td class="text-end pe-4">
                        {% if devedor.fone_link %}
                            <a href="#" 
                               class="btn-zap btn btn-success btn-sm rounded-pill px-4 fw-bold"
                               data-fone="{{ devedor.fone_link }}"
                               data-nome="{{ devedor.nome_tratamento }}" 
                               data-aluno="{{ devedor.nome_aluno_msg }}"
                               data-curso="{{ devedor.nome_cursos }}"
                               target="_blank">
                               <i class="bi bi-whatsapp"></i> Enviar
                            </a>
                        {% else %}
                            <span class="badge bg-secondary">Sem n√∫mero</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center py-5">Ningu√©m devendo neste per√≠odo! üéâ</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function atualizarLinks() {
        // 1. Pega o modelo de texto selecionado no topo
        let select = document.getElementById('selectMensagem'); // Certifique-se que o ID do seu select √© 'selectMensagem'
        if (!select) return; // Seguran√ßa caso o select n√£o exista

        let textoBase = select.value;
        
        // 2. Atualiza todos os bot√µes da lista
        let botoes = document.querySelectorAll('.btn-zap');
        
        botoes.forEach(btn => {
            let fone = btn.getAttribute('data-fone');
            
            // Pega os dados espec√≠ficos desta linha
            let nomeTratamento = btn.getAttribute('data-nome'); // [NOME]
            let nomeAluno = btn.getAttribute('data-aluno');     // [ALUNO]
            let nomeCurso = btn.getAttribute('data-curso');     // [CURSO]
            
            // 3. FAZ AS SUBSTITUI√á√ïES
            let textoFinal = textoBase
                .replace('[NOME]', nomeTratamento)
                .replace('[ALUNO]', nomeAluno)
                .replace('[CURSO]', nomeCurso);
            
            // Garante compatibilidade caso o usu√°rio digite min√∫sculo ou entre chaves por h√°bito
            textoFinal = textoFinal
                .replace('{nome}', nomeTratamento)
                .replace('{aluno}', nomeAluno)
                .replace('{curso}', nomeCurso);

            // 4. Monta o Link
            let textoCodificado = encodeURIComponent(textoFinal);
            btn.href = `https://wa.me/${fone}?text=${textoCodificado}`;
        });
    }

    // Atualiza ao carregar e sempre que mudar a op√ß√£o do select
    document.addEventListener("DOMContentLoaded", atualizarLinks);
    
    // Adiciona o evento de change no select manualmente para garantir
    let selectElement = document.getElementById('selectMensagem');
    if (selectElement) {
        selectElement.addEventListener('change', atualizarLinks);
    }
</script>

{% endblock %}